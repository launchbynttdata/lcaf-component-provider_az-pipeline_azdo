# This template will validate the branch name meets our requirements for automated versioning.
# The following variables must be present in the current scope for this job to run:
#  poolName: The name of the ADO Agent pool to run the job on.
#  serviceConnection: The name of the Service Connection to utilize
#  buildSourceBranch: The branch of the triggering repo the build was queued for.
#  pullRequestTargetBranch: The name of the target branch for a pull request.

parameters:
  - name: poolName
    type: string
  - name: serviceConnection
    type: string
  - name: buildSourceBranch
    type: string
  - name: pullRequestTargetBranch
    type: string

stages:
  - stage: BranchNameValidation
    displayName: Branch Name Validation
    jobs:
      - template: /common/jobs/generic-job.yaml
        parameters:
          jobName: PlatformValidation
          jobDisplayName: Platform Validation
          poolName: ${{ parameters.poolName }}
          steps:
            - template: /common/steps/has_semver_tag.yaml
              parameters:
                serviceConnection: ${{ parameters.serviceConnection }}
            - task: AzureClI@2
              name: Debug
              displayName: Debug
              inputs:
                scriptType: bash
                scriptLocation: inlineScript
                workingDirectory: $(System.DefaultWorkingDirectory)
                inlineScript: |
                  export PATH=/home/launch/env/bin:$PATH
                  echo PULL_REQUEST_TARGET_BRANCH=$PULL_REQUEST_TARGET_BRANCH
                  echo HAS_SEMVER_TAG=$HAS_SEMVER_TAG
                  echo FORCE_BRANCH_NAME_VALIDATION=$FORCE_BRANCH_NAME_VALIDATION
                  echo "---"
                  env | sort
                azureSubscription: ${{ parameters.serviceConnection }}
                addSpnToEnvironment: true
              env:
                PULL_REQUEST_TARGET_BRANCH: ${{ parameters.pullRequestTargetBranch }}
                HAS_SEMVER_TAG: $(HasSemverTag)
                FORCE_BRANCH_NAME_VALIDATION: ${{ parameters.forceBranchNameValidation }}
            - ${{ if eq(parameters.pullRequestTargetBranch, 'refs/heads/main') }}:
              - task: AzureClI@2
                name: MainCheck
                displayName: MainCheck
                inputs:
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: $(System.DefaultWorkingDirectory)
                  inlineScript: |
                    export PATH=/home/launch/env/bin:$PATH
                    echo "eq(parameters.pullRequestTargetBranch, 'refs/heads/main')"
                    echo OUTCOME=$OUTCOME
                  azureSubscription: ${{ parameters.serviceConnection }}
                  addSpnToEnvironment: true
                env:
                  OUTCOME: ${{ parameters.pullRequestTargetBranch }}
            - ${{ else }}:
              - task: AzureClI@2
                name: MainCheckFailed
                displayName: MainCheckFailed
                inputs:
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: $(System.DefaultWorkingDirectory)
                  inlineScript: |
                    export PATH=/home/launch/env/bin:$PATH
                    echo "eq(parameters.pullRequestTargetBranch, 'refs/heads/main') FAILED"
                    echo OUTCOME=$OUTCOME
                  azureSubscription: ${{ parameters.serviceConnection }}
                  addSpnToEnvironment: true
                env:
                  OUTCOME: ${{ parameters.pullRequestTargetBranch }}
            - ${{ if eq(variables['HasSemverTag'], 'true') }}:
              - task: AzureClI@2
                name: SemverCheck
                displayName: SemverCheck
                inputs:
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: $(System.DefaultWorkingDirectory)
                  inlineScript: |
                    export PATH=/home/launch/env/bin:$PATH
                    echo "eq(variables['HasSemverTag'], 'true')"
                    echo OUTCOME=$OUTCOME
                  azureSubscription: ${{ parameters.serviceConnection }}
                  addSpnToEnvironment: true
                env:
                  OUTCOME: $(HasSemverTag)
            - ${{ else }}:
              - task: AzureClI@2
                name: SemverCheckFailed
                displayName: SemverCheckFailed
                inputs:
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: $(System.DefaultWorkingDirectory)
                  inlineScript: |
                    export PATH=/home/launch/env/bin:$PATH
                    echo "eq(variables['HasSemverTag'], 'true') FAILED"
                    echo OUTCOME=$OUTCOME
                  azureSubscription: ${{ parameters.serviceConnection }}
                  addSpnToEnvironment: true
                env:
                  OUTCOME: $(HasSemverTag)
            - ${{ if or(eq(parameters.pullRequestTargetBranch, 'refs/heads/main'), eq(variables['HasSemverTag'], 'true')) }}:
              - template: /common/steps/launch_validate_branch_name.yaml
                parameters:
                  serviceConnection: ${{ parameters.serviceConnection }}
                  pullRequestSourceBranch: $(pullRequestSourceBranch)
