parameters:
  - name: gitRepo
    type: string
  - name: gitBranch
    type: string
  - name: gitCommit
    type: string
  - name: armServiceConnection
    type: string
  - name: gitHubToken
    type: string
    default: $(GITHUB_PAT)
  - name: condition
    type: string
    default: true

jobs:
  - job: ValidateAzurermModule
    displayName: Validate terraform module
    condition: ${{ parameters.condition }}
    variables:
      ASDF_INSTALL_DIR: '$HOME/.asdf'
      ASDF_SCRIPT_FILE: '$HOME/.asdf/asdf.sh'
      CURRENT_PROJECT_URL: '$(System.TeamFoundationCollectionUri)$(System.TeamProjectId)'
      CURRENT_BUILD_URL: '$(CURRENT_PROJECT_URL)/_build/results?buildId=$(Build.BuildId)'
    steps:
      - checkout: none

      - template: ../steps/post-github-commit-status.yaml
        parameters:
          gitRepo: ${{ parameters.gitRepo }}
          gitCommit: ${{ parameters.gitCommit }}
          gitHubToken: ${{ parameters.gitHubToken }}
          statusData: >-
            {
              "state": "pending",
              "description": "Validate terraform module",
              "target_url": "$(CURRENT_BUILD_URL)",
              "context": "azpipelines/validate-azurerm-module"
            }

      - task: Bash@3
        displayName: 'Install repo tool'
        inputs:
          targetType: 'inline'
          script: |
            HOME_BIN="$HOME/.bin"
            REPO_BIN_PATH="$HOME_BIN/repo"

            mkdir -p "$HOME_BIN"
            echo "##vso[task.prependpath]$HOME_BIN"

            curl https://storage.googleapis.com/git-repo-downloads/repo > "$REPO_BIN_PATH"
            chmod a+rx "$REPO_BIN_PATH"

            "$REPO_BIN_PATH" version

      - task: Bash@3
        displayName: 'Install asdf version manager'
        inputs:
          targetType: 'inline'
          script: |
            git clone https://github.com/asdf-vm/asdf.git ${{ variables.ASDF_INSTALL_DIR }} --branch v0.14.1

      - task: Bash@3
        displayName: 'Checkout terraform module'
        inputs:
          targetType: 'inline'
          script: |
            git clone https://${{ parameters.gitHubToken }}@github.com/${{ parameters.gitRepo }}.git . --branch ${{ parameters.gitBranch }}

      - task: Bash@3
        displayName: 'Configure dependencies'
        inputs:
          targetType: 'inline'
          script: |
            git config --global user.name 'azpipelines'
            git config --global user.email 'job@dev.azure.com'
            . ${{ variables.ASDF_SCRIPT_FILE }} && make configure

      - task: AzureCLI@2
        displayName: 'Validate terraform module'
        env:
          GO_LINT_TIMEOUT: 10m
          GO_TEST_TIMEOUT: 45m
        inputs:
          azureSubscription: ${{ parameters.armServiceConnection }}
          scriptLocation: 'inlineScript'
          scriptType: 'bash'
          inlineScript: |
            . ${{ variables.ASDF_SCRIPT_FILE }} && make check

      - task: Bash@3
        condition: always()
        inputs:
          targetType: 'inline'
          script: |
            echo "$(Agent.JobStatus)"
            if [ "$(Agent.JobStatus)" = "Succeeded" ] || [ "$(Agent.JobStatus)" = "SucceededWithIssues" ]; then
              echo "##vso[task.setvariable variable=GITHUB_COMMIT_STATUS]success"
            else
              echo "##vso[task.setvariable variable=GITHUB_COMMIT_STATUS]failure"
            fi

      - template: ../steps/post-github-commit-status.yaml
        parameters:
          gitRepo: ${{ parameters.gitRepo }}
          gitCommit: ${{ parameters.gitCommit }}
          gitHubToken: ${{ parameters.gitHubToken }}
          condition: always()
          statusData: >-
            {
              "state": "$(GITHUB_COMMIT_STATUS)",
              "description": "Validate terraform module",
              "target_url": "$(CURRENT_BUILD_URL)",
              "context": "azpipelines/validate-azurerm-module"
            }
